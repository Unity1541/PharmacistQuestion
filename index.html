<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹è€ƒå¤§æŒ‘æˆ° - ã‚¢ãƒ‹ãƒ¡ã‚¯ã‚¤ã‚º</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        /* å‹•æ¼«é¢¨æ ¼èƒŒæ™¯å‹•ç•« */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
        }

        .sakura {
            position: absolute;
            color: #ff69b4;
            animation: fall 10s linear infinite;
            font-size: 20px;
        }

        @keyframes fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }

        .title {
            font-size: 2.5em;
            color: #4a5568;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            font-weight: 700;
        }

        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
            position: relative;
            z-index: 1;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4a5568;
        }

        .timer {
            color: #e53e3e !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .level-badge {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .question-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            position: relative;
            z-index: 1;
        }

        .question-number {
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.3em;
            color: #2d3748;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .options {
            display: grid;
            gap: 10px;
        }

        .option {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            position: relative;
            overflow: hidden;
        }

        .option:hover {
            background: #edf2f7;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
            animation: correctAnswer 0.6s ease;
        }

        .option.incorrect {
            background: #f56565;
            color: white;
            border-color: #f56565;
            animation: incorrectAnswer 0.6s ease;
        }

        @keyframes correctAnswer {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectAnswer {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result {
            text-align: center;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
        }

        .answers-review {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
        }

        .review-title {
            text-align: center;
            font-size: 1.5em;
            color: #4a5568;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .answer-item {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #e2e8f0;
        }

        .answer-item.correct-answer {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .answer-item.wrong-answer {
            border-left-color: #f56565;
            background: #fffaf0;
        }

        .review-question {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .review-options {
            margin-bottom: 10px;
        }

        .review-option {
            padding: 5px 0;
            color: #4a5568;
        }

        .review-option.user-choice {
            color: #f56565;
            font-weight: bold;
        }

        .review-option.correct-choice {
            color: #48bb78;
            font-weight: bold;
        }

        .review-option.user-correct {
            color: #48bb78;
            font-weight: bold;
        }

        .answer-status {
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 5px;
        }

        .answer-status.correct {
            color: #48bb78;
        }

        .answer-status.incorrect {
            color: #f56565;
        }

        .toggle-answers-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
            font-weight: bold;
        }

        .toggle-answers-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .result-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #4a5568;
        }

        .result-score {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-message {
            font-size: 1.2em;
            color: #718096;
            margin-bottom: 20px;
        }

        .final-level {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .loading {
            text-align: center;
            padding: 50px;
            position: relative;
            z-index: 1;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .firebase-config {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .config-title {
            color: #4a5568;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .config-text {
            color: #718096;
            font-size: 0.9em;
            line-height: 1.5;
        }

        @media (max-width: 600px) {
            .container {
                margin: 20px;
                padding: 20px;
            }
            
            .title {
                font-size: 2em;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation" id="bgAnimation"></div>

    <div class="container">
        <div class="header">
            <h1 class="title">ğŸŒ¸ æ–°æ‰‹æŒ‘æˆ°åœ‹è€ƒå€ ğŸŒ¸</h1>
            <p class="subtitle">ã‚¢ãƒ‹ãƒ¡ã‚¯ã‚¤ã‚º - Pharmacist Quiz</p>
        </div>

        <div class="firebase-config" id="firebaseConfig">
            <div class="config-title">ğŸ”§ Firebase é…ç½®</div>
            <div class="config-text">
                è«‹åœ¨ä¸‹æ–¹ `firebaseConfig` è®Šæ•¸ä¸­å¡«å…¥ä½ çš„å°ˆæ¡ˆè³‡è¨Š<br>
                ä¸¦ç¢ºä¿ Firestore ä¸­æœ‰ä¸€å€‹åç‚º **`Questions`** çš„é›†åˆ (è€Œä¸æ˜¯ `quiz_questions`)ï¼Œ<br>
                ä¸”å…¶æ–‡ä»¶çµæ§‹ç¬¦åˆç¯„ä¾‹ã€‚
            </div>
        </div>

        <div class="stats-bar" id="statsBar" style="display: none;">
            <div class="stat-item">
                <div class="stat-label">æ™‚é–“</div>
                <div class="stat-value timer" id="timer">60</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">åˆ†æ•¸</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ç­‰ç´š</div>
                <div class="level-badge" id="level">åˆå¿ƒè€…</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">é¡Œç›®</div>
                <div class="stat-value" id="progress">1/10</div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>æ­£åœ¨è¼‰å…¥é¡Œç›®...</p>
        </div>

        <div class="error" id="error" style="display: none;"></div>

        <div class="question-container" id="questionContainer" style="display: none;">
            <div class="question-number" id="questionNumber">é¡Œç›® 1 / 10</div>
            <div class="question-text" id="questionText"></div>
            <div class="options" id="options"></div>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <button class="btn" id="startBtn" onclick="startQuiz()">é–‹å§‹æ¸¬é©—</button>
            <button class="btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">ä¸‹ä¸€é¡Œ</button>
            <button class="btn" id="restartBtn" onclick="restartQuiz()" style="display: none;">é‡æ–°é–‹å§‹</button>
        </div>

        <div class="result" id="result" style="display: none;">
            <h2 class="result-title">æ¸¬é©—å®Œæˆï¼</h2>
            <div class="result-score" id="finalScore">0</div>
            <div class="result-message" id="resultMessage"></div>
            <div class="final-level" id="finalLevel"></div>
            <div>
                <button class="toggle-answers-btn" id="toggleAnswersBtn" onclick="toggleAnswersReview()">æŸ¥çœ‹è§£ç­”</button>
                <button class="btn" onclick="restartQuiz()">å†æ¬¡æŒ‘æˆ°</button>
            </div>
            
            <div class="answers-review" id="answersReview" style="display: none;">
                <div class="review-title">ğŸ“ ç­”æ¡ˆè§£æ</div>
                <div id="answersContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>

    <script>
        // ================================
        // Firebase é…ç½® - è«‹å¡«å…¥ä½ çš„é…ç½®è³‡è¨Š
        // ================================
        const firebaseConfig = {
            apiKey: "AIzaSyBxNN0bWC0kIzeIxFwc9tGFraup0DQef5o", // <-- å°‡æ­¤æ›¿æ›ç‚ºä½ çš„ API Key
            authDomain: "testdatabase-b1c0b.firebaseapp.com", // <-- å°‡æ­¤æ›¿æ›ç‚ºä½ çš„ Project ID
            projectId: "testdatabase-b1c0b", // <-- å°‡æ­¤æ›¿æ›ç‚ºä½ çš„ Project ID
            storageBucket: "testdatabase-b1c0b.firebasestorage.app", // <-- å°‡æ­¤æ›¿æ›ç‚ºä½ çš„ Project ID
            messagingSenderId: "695517699476", // <-- å°‡æ­¤æ›¿æ›ç‚ºä½ çš„ Messaging Sender ID
            appId: "1:695517699476:web:8e998a2a5865157dad4381" // <-- å°‡æ­¤æ›¿æ›ç‚ºä½ çš„ App ID
        };

        // ================================
        // å…¨åŸŸè®Šæ•¸
        // ================================
        let db;
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let timeLeft = 60;
        let timer = null;
        let selectedAnswer = null;
        let isFirebaseConfigured = false;
        let userAnswers = []; // å„²å­˜ä½¿ç”¨è€…çš„ç­”æ¡ˆ

        // ç­‰ç´šç³»çµ±
        const levels = [
            { name: "åˆå¿ƒè€…", minScore: 0, color: "#9ca3af" },
            { name: "è¦‹ç¿’ç”Ÿ", minScore: 20, color: "#10b981" },
            { name: "ä¸­ç´šè€…", minScore: 40, color: "#3b82f6" },
            { name: "ä¸Šç´šè€…", minScore: 60, color: "#8b5cf6" },
            { name: "å°ˆå®¶", minScore: 80, color: "#f59e0b" },
            { name: "å¤§å¸«", minScore: 95, color: "#ef4444" }
        ];

        // ç¯„ä¾‹é¡Œç›®ï¼ˆç•¶ Firebase ç„¡æ³•ä½¿ç”¨æˆ–æ²’æœ‰é¡Œç›®æ™‚çš„å¾Œå‚™ï¼‰
        const sampleQuestions = [
            {
                question: "ä»¥ä¸‹å“ªéƒ¨å‹•ç•«æ˜¯å®®å´é§¿åŸ·å°çš„ä½œå“ï¼Ÿ",
                options: ["é¾è²“", "ä½ çš„åå­—", "é¬¼æ»…ä¹‹åˆƒ", "é€²æ“Šçš„å·¨äºº"],
                correct: 0,
                explanation: "ã€Šé¾è²“ã€‹æ˜¯å®®å´é§¿åœ¨1988å¹´åŸ·å°çš„ç¶“å…¸å‹•ç•«é›»å½±ï¼Œæ˜¯å‰åœåŠ›å·¥ä½œå®¤çš„ä»£è¡¨ä½œå“ä¹‹ä¸€ã€‚"
            },
            {
                question: "ã€Šç«å½±å¿è€…ã€‹ä¸­ä¸»è§’çš„åå­—æ˜¯ï¼Ÿ",
                options: ["æ¼©æ¸¦é³´äºº", "å®‡æ™ºæ³¢ä½åŠ©", "æ˜¥é‡æ«»", "æ——æœ¨å¡å¡è¥¿"],
                correct: 0,
                explanation: "æ¼©æ¸¦é³´äººæ˜¯ã€Šç«å½±å¿è€…ã€‹çš„ä¸»è§’ï¼Œå¤¢æƒ³æˆç‚ºç«å½±ï¼Œæ“æœ‰ä¹å°¾å¦–ç‹çš„åŠ›é‡ã€‚"
            },
            {
                question: "ã€Šèˆªæµ·ç‹ã€‹çš„ä½œè€…æ˜¯èª°ï¼Ÿ",
                options: ["é³¥å±±æ˜", "å°¾ç”°æ¦®ä¸€éƒ", "å²¸æœ¬é½Šå²", "ä¹…ä¿å¸¶äºº"],
                correct: 1,
                explanation: "å°¾ç”°æ¦®ä¸€éƒæ˜¯ã€Šèˆªæµ·ç‹ã€‹(One Piece)çš„ä½œè€…ï¼Œé€™éƒ¨ä½œå“è‡ª1997å¹´é–‹å§‹é€£è¼‰è‡³ä»Šã€‚"
            },
            {
                question: "ä»¥ä¸‹å“ªéƒ¨ä½œå“ä¸æ˜¯å‰åœåŠ›å·¥ä½œå®¤è£½ä½œçš„ï¼Ÿ",
                options: ["å¤©ç©ºä¹‹åŸ", "é­”å¥³å®…æ€¥ä¾¿", "ä½ çš„åå­—", "é¢¨ä¹‹è°·"],
                correct: 2,
                explanation: "ã€Šä½ çš„åå­—ã€‹æ˜¯ç”±æ–°æµ·èª åŸ·å°çš„ä½œå“ï¼Œç”±CoMix Wave Filmsè£½ä½œï¼Œä¸æ˜¯å‰åœåŠ›å·¥ä½œå®¤çš„ä½œå“ã€‚"
            },
            {
                question: "ã€Šé¬¼æ»…ä¹‹åˆƒã€‹ä¸­ç‚­æ²»éƒä½¿ç”¨çš„å‘¼å¸æ³•æ˜¯ï¼Ÿ",
                options: ["æ°´ä¹‹å‘¼å¸", "ç«ä¹‹å‘¼å¸", "é¢¨ä¹‹å‘¼å¸", "æ—¥ä¹‹å‘¼å¸"],
                correct: 0,
                explanation: "ç‚­æ²»éƒæœ€åˆå­¸ç¿’çš„æ˜¯æ°´ä¹‹å‘¼å¸ï¼Œå¾Œä¾†è¦ºé†’äº†æ—¥ä¹‹å‘¼å¸ï¼Œä½†æ°´ä¹‹å‘¼å¸æ˜¯ä»–çš„åŸºç¤æ‹›å¼ã€‚"
            }
        ];

        // ================================
        // åˆå§‹åŒ–
        // ================================
        window.onload = function() {
            initFirebase();
            createBackgroundAnimation();
            checkFirebaseConfig();
        };

        function initFirebase() {
            try {
                // æª¢æŸ¥ Firebase é…ç½®æ˜¯å¦æœ‰æ•ˆ (åˆ¤æ–·æ˜¯å¦ç‚ºé è¨­å€¼)
                if (firebaseConfig.apiKey !== "YOUR_API_KEY" && 
                    firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    isFirebaseConfigured = true;
                    console.log("Firebase åˆå§‹åŒ–æˆåŠŸ");
                } else {
                    console.log("Firebase é…ç½®æœªå¡«å¯«ï¼Œå°‡ä½¿ç”¨ç¯„ä¾‹é¡Œç›®æ¨¡å¼");
                    showError("Firebase é…ç½®æœªå¡«å¯«ï¼Œè«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥ä½ çš„å°ˆæ¡ˆè³‡è¨Šã€‚");
                }
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
                showError("Firebase é€£æ¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é…ç½®è³‡è¨Šæ˜¯å¦æ­£ç¢ºã€‚å°‡ä½¿ç”¨ç¯„ä¾‹é¡Œç›®ã€‚");
            }
        }

        function checkFirebaseConfig() {
            if (isFirebaseConfigured) {
                document.getElementById('firebaseConfig').style.display = 'none'; // éš±è—æç¤º
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('loading').style.display = 'none';
            } else {
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ================================
        // èƒŒæ™¯å‹•ç•«
        // ================================
        function createBackgroundAnimation() {
            const bgAnimation = document.getElementById('bgAnimation');
            const sakuraSymbols = ['ğŸŒ¸', 'ğŸŒº', 'ğŸ‹', 'ğŸŒ¿', 'ğŸƒ'];
            
            setInterval(() => {
                if (document.querySelectorAll('.sakura').length < 10) {
                    const sakura = document.createElement('div');
                    sakura.className = 'sakura';
                    sakura.textContent = sakuraSymbols[Math.floor(Math.random() * sakuraSymbols.length)];
                    sakura.style.left = Math.random() * 100 + '%';
                    sakura.style.animationDuration = (Math.random() * 5 + 5) + 's';
                    sakura.style.animationDelay = Math.random() * 2 + 's';
                    bgAnimation.appendChild(sakura);
                    
                    setTimeout(() => {
                        if (sakura.parentNode) {
                            sakura.parentNode.removeChild(sakura);
                        }
                    }, 12000);
                }
            }, 1000);
        }

        // ================================
        // æ¸¬é©—é‚è¼¯
        // ================================
        async function startQuiz() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('controls').style.display = 'none';
                document.getElementById('error').style.display = 'none';
                
                // è¼‰å…¥é¡Œç›®
                await loadQuestions();
                
                if (questions.length === 0) {
                    throw new Error("æ²’æœ‰æ‰¾åˆ°é¡Œç›®ï¼Œè«‹æª¢æŸ¥ Firebase æˆ–ä½¿ç”¨ç¯„ä¾‹é¡Œç›®ã€‚");
                }
                
                // åˆå§‹åŒ–æ¸¬é©—ç‹€æ…‹
                currentQuestionIndex = 0;
                score = 0;
                timeLeft = 60;
                selectedAnswer = null;
                userAnswers = []; // é‡ç½®ä½¿ç”¨è€…ç­”æ¡ˆ
                
                // é¡¯ç¤ºæ¸¬é©—ç•Œé¢
                document.getElementById('loading').style.display = 'none';
                document.getElementById('statsBar').style.display = 'flex';
                document.getElementById('questionContainer').style.display = 'block';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('startBtn').style.display = 'none';
                
                // é–‹å§‹è¨ˆæ™‚
                startTimer();
                
                // é¡¯ç¤ºç¬¬ä¸€é¡Œ
                showQuestion();
                
            } catch (error) {
                console.error("é–‹å§‹æ¸¬é©—å¤±æ•—:", error);
                showError("è¼‰å…¥é¡Œç›®å¤±æ•—: " + error.message);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('startBtn').style.display = 'inline-block'; // ç¢ºä¿é–‹å§‹æŒ‰éˆ•å¯è¦‹
            }
        }

        async function loadQuestions() {
            if (isFirebaseConfigured) {
                try {
                    // å¾ 'Questions' é›†åˆä¸­è®€å–æ–‡ä»¶
                    const snapshot = await db.collection('Questions').get(); // <-- é›†åˆåç¨±å¾ 'quiz_questions' æ”¹ç‚º 'Questions'
                    questions = [];
                    const optionKeys = ['A', 'B', 'C', 'D']; // å®šç¾©é¸é …çš„éµ
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // ç¢ºä¿æ•¸æ“šçµæ§‹ç¬¦åˆé æœŸï¼Œä¸¦ä¸”é€²è¡Œæ ¼å¼è½‰æ›
                        if (data.text && data.options && data.answer) {
                            const newOptions = [];
                            let correctAnswerIndex = -1;
                            
                            // å°‡ options ç‰©ä»¶è½‰æ›ç‚ºé™£åˆ—
                            optionKeys.forEach((key, index) => {
                                if (data.options[key]) {
                                    newOptions.push(data.options[key]);
                                    if (key === data.answer) {
                                        correctAnswerIndex = index;
                                    }
                                }
                            });

                            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰é¸é …éƒ½å­˜åœ¨ï¼Œä¸¦ä¸”æ­£ç¢ºç­”æ¡ˆç´¢å¼•æœ‰æ•ˆ
                            if (newOptions.length > 0 && correctAnswerIndex !== -1) {
                                questions.push({
                                    question: data.text,
                                    options: newOptions,
                                    correct: correctAnswerIndex,
                                    explanation: data.explanation || "æš«ç„¡è§£æ"
                                });
                            } else {
                                console.warn(`æ–‡æª” ${doc.id} æ ¼å¼ä¸æ­£ç¢ºæˆ–é¸é …ç¼ºå¤±ï¼Œå·²è·³éã€‚`, data);
                            }
                        } else {
                            console.warn(`æ–‡æª” ${doc.id} ç¼ºå°‘å¿…è¦å­—æ®µ (text, options, answer)ï¼Œå·²è·³éã€‚`, data);
                        }
                    });
                    
                    if (questions.length === 0) {
                        console.log("Firestore ä¸­æ²’æœ‰ç¬¦åˆæ ¼å¼çš„é¡Œç›®ï¼Œä½¿ç”¨ç¯„ä¾‹é¡Œç›®");
                        questions = [...sampleQuestions];
                    }
                } catch (error) {
                    console.error("å¾ Firestore è¼‰å…¥é¡Œç›®å¤±æ•—:", error);
                    showError("å¾ Firestore è¼‰å…¥é¡Œç›®å¤±æ•—ï¼Œå°‡ä½¿ç”¨ç¯„ä¾‹é¡Œç›®ã€‚éŒ¯èª¤ï¼š" + error.message);
                    questions = [...sampleQuestions];
                }
            } else {
                questions = [...sampleQuestions];
            }
            
            // éš¨æ©Ÿæ‰“äº‚é¡Œç›®é †åº
            questions = shuffleArray(questions);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                endQuiz();
                return;
            }
            
            const question = questions[currentQuestionIndex];
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('questionNumber').textContent = 
                `é¡Œç›® ${currentQuestionIndex + 1} / ${questions.length}`;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('progress').textContent = 
                `${currentQuestionIndex + 1}/${questions.length}`;
            
            // ç”Ÿæˆé¸é …
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optionDiv);
            });
            
            selectedAnswer = null;
            document.getElementById('nextBtn').disabled = true;
        }

        function selectAnswer(answerIndex) {
            // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // æ¨™è¨˜æ–°é¸æ“‡
            document.querySelectorAll('.option')[answerIndex].classList.add('selected');
            selectedAnswer = answerIndex;
            document.getElementById('nextBtn').disabled = false;
        }

        function nextQuestion() {
            if (selectedAnswer === null) return;
            
            const question = questions[currentQuestionIndex];
            const isCorrect = selectedAnswer === question.correct;
            
            // å„²å­˜ä½¿ç”¨è€…çš„ç­”æ¡ˆ
            userAnswers.push({
                questionIndex: currentQuestionIndex,
                question: question.question,
                options: question.options,
                userAnswer: selectedAnswer,
                correctAnswer: question.correct,
                isCorrect: isCorrect,
                explanation: question.explanation || "æš«ç„¡è§£æ"
            });
            
            // é¡¯ç¤ºç­”æ¡ˆ
            document.querySelectorAll('.option').forEach((option, index) => {
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedAnswer && !isCorrect) {
                    option.classList.add('incorrect');
                }
                option.onclick = null; // ç¦ç”¨é»æ“Š
            });
            
            // æ›´æ–°åˆ†æ•¸
            if (isCorrect) {
                score += 20;
                updateScore();
            }
            
            // å»¶é²é¡¯ç¤ºä¸‹ä¸€é¡Œ
            setTimeout(() => {
                currentQuestionIndex++;
                showQuestion();
            }, 1500);
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
            
            // æ›´æ–°ç­‰ç´š
            const currentLevel = getCurrentLevel();
            const levelBadge = document.getElementById('level');
            levelBadge.textContent = currentLevel.name;
            levelBadge.style.background = `linear-gradient(45deg, ${currentLevel.color}, #4ecdc4)`;
        }

        function getCurrentLevel() {
            for (let i = levels.length - 1; i >= 0; i--) {
                if (score >= levels[i].minScore) {
                    return levels[i];
                }
            }
            return levels[0];
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    endQuiz();
                }
            }, 1000);
        }

        function endQuiz() {
            clearInterval(timer);
            
            // å¦‚æœæ™‚é–“åˆ°äº†ä½†é‚„æœ‰æœªå›ç­”çš„é¡Œç›®ï¼Œå°‡å‰©é¤˜é¡Œç›®æ¨™è¨˜ç‚ºæœªå›ç­”
            while (currentQuestionIndex < questions.length) {
                const question = questions[currentQuestionIndex];
                userAnswers.push({
                    questionIndex: currentQuestionIndex,
                    question: question.question,
                    options: question.options,
                    userAnswer: -1, // -1 è¡¨ç¤ºæœªå›ç­”
                    correctAnswer: question.correct,
                    isCorrect: false,
                    explanation: question.explanation || "æš«ç„¡è§£æ"
                });
                currentQuestionIndex++;
            }
            
            // éš±è—æ¸¬é©—ç•Œé¢
            document.getElementById('statsBar').style.display = 'none';
            document.getElementById('questionContainer').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            
            // é¡¯ç¤ºçµæœ
            const finalLevel = getCurrentLevel();
            document.getElementById('finalScore').textContent = score + 'åˆ†';
            document.getElementById('finalLevel').textContent = finalLevel.name;
            document.getElementById('finalLevel').style.background = 
                `linear-gradient(45deg, ${finalLevel.color}, #4ecdc4)`;
            
            // çµæœè¨Šæ¯
            let message = "";
            if (score >= 80) {
                message = "å¤ªå²å®³äº†ï¼åœ‹è€ƒé”äººï¼ğŸ‰";
            } else if (score >= 60) {
                message = "å¾ˆä¸éŒ¯ï¼åˆå­¸è€…å·²ç¶“å¾ˆå²å®³ï¼ğŸ‘";
            } else if (score >= 40) {
                message = "é‚„å¯ä»¥ï¼ç¹¼çºŒåŠªåŠ›å­¸ç¿’å§ï¼ğŸ“š";
            } else {
                message = "åŠ æ²¹ï¼å¤šçœ‹å¹¾éï¼ğŸ’ª";
            }
            
            document.getElementById('resultMessage').textContent = message;
            document.getElementById('result').style.display = 'block';
            
            // ç”Ÿæˆç­”æ¡ˆå›é¡§å…§å®¹
            generateAnswersReview();
        }

        function restartQuiz() {
            // é‡ç½®ç‹€æ…‹
            currentQuestionIndex = 0;
            score = 0;
            timeLeft = 60;
            selectedAnswer = null;
            userAnswers = [];
            
            // éš±è—çµæœé é¢å’Œç­”æ¡ˆå›é¡§
            document.getElementById('result').style.display = 'none';
            document.getElementById('answersReview').style.display = 'none';
            document.getElementById('toggleAnswersBtn').textContent = 'æŸ¥çœ‹è§£ç­”';
            
            // é¡¯ç¤ºé–‹å§‹æŒ‰éˆ•
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
        }

        function generateAnswersReview() {
            const answersContent = document.getElementById('answersContent');
            answersContent.innerHTML = '';
            
            userAnswers.forEach((answer, index) => {
                const answerDiv = document.createElement('div');
                answerDiv.className = `answer-item ${answer.isCorrect ? 'correct-answer' : 'wrong-answer'}`;
                
                let optionsHtml = '';
                answer.options.forEach((option, optionIndex) => {
                    let optionClass = 'review-option';
                    let prefix = '';
                    
                    if (optionIndex === answer.correctAnswer) {
                        optionClass += ' correct-choice';
                        prefix = 'âœ… ';
                    }
                    
                    if (optionIndex === answer.userAnswer) {
                        if (answer.isCorrect) {
                            optionClass += ' user-correct';
                            prefix = 'âœ… ';
                        } else if (answer.userAnswer !== -1) {
                            optionClass += ' user-choice';
                            prefix = 'âŒ ';
                        }
                    }
                    
                    if (answer.userAnswer === -1 && optionIndex === answer.correctAnswer) {
                        prefix = 'âœ… ';
                    }
                    
                    optionsHtml += `<div class="${optionClass}">${prefix}${option}</div>`;
                });
                
                let statusText = '';
                let statusClass = '';
                if (answer.userAnswer === -1) {
                    statusText = 'â° æœªå›ç­”';
                    statusClass = 'incorrect';
                } else if (answer.isCorrect) {
                    statusText = 'ğŸ‰ å›ç­”æ­£ç¢ºï¼';
                    statusClass = 'correct';
                } else {
                    statusText = 'ğŸ’ª ç­”éŒ¯äº†ï¼Œç¹¼çºŒåŠ æ²¹ï¼';
                    statusClass = 'incorrect';
                }
                
                answerDiv.innerHTML = `
                    <div class="review-question">ç¬¬${index + 1}é¡Œï¼š${answer.question}</div>
                    <div class="review-options">${optionsHtml}</div>
                    <div class="answer-status ${statusClass}">${statusText}</div>
                    ${answer.explanation ? `<div style="margin-top: 10px; color: #4a5568; font-style: italic;">ğŸ’¡ ${answer.explanation}</div>` : ''}
                `;
                
                answersContent.appendChild(answerDiv);
            });
        }

        function toggleAnswersReview() {
            const answersReview = document.getElementById('answersReview');
            const toggleBtn = document.getElementById('toggleAnswersBtn');
            
            if (answersReview.style.display === 'none') {
                answersReview.style.display = 'block';
                toggleBtn.textContent = 'éš±è—è§£ç­”';
            } else {
                answersReview.style.display = 'none';
                toggleBtn.textContent = 'æŸ¥çœ‹è§£ç­”';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // ================================
        // Firestore æ•¸æ“šçµæ§‹åƒè€ƒ
        // ================================
        /*
        åœ¨ Firestore ä¸­å‰µå»º 'Questions' é›†åˆï¼Œæ¯å€‹æ–‡æª” (ä¾‹å¦‚ doc id 'question001') åŒ…å«ï¼š
        {
            "question004": {
            "type": "multiple_choice",
            "text": "M2-muscarinic receptoråœ¨å¿ƒè‡Ÿæ´»åŒ–æ™‚ï¼Œæœƒé€éå“ªç¨®Gè›‹ç™½é€”å¾‘å°è‡´å¿ƒç‡æ¸›æ…¢ï¼Ÿ",
            "options": {
                "A": "Gsè›‹ç™½",
                "B": "Gqè›‹ç™½",
                "C": "Giè›‹ç™½",
                "D": "Goè›‹ç™½"
            },
            "answer": "C",
            "explanation":
        }
        
        ä¾‹å¦‚ï¼š
        åœ¨ Firestore çš„ 'Questions' é›†åˆä¸‹ï¼Œæœ‰ä¸€å€‹æ–‡ä»¶ (ä¾‹å¦‚ ID ç‚º 'question001')ï¼š
        {
          "type": "multiple_choice",
          "text": "ä»¥ä¸‹å“ªç¨®å‹•ç‰©æ˜¯å“ºä¹³é¡ï¼Ÿ",
          "options": {
            "A": "éº»é›€",
            "B": "é±·é­š",
            "C": "é¯¨é­š",
            "D": "é’è›™"
          },
          "answer": "C",
          "explanation": "é¯¨é­šé›–ç„¶ç”Ÿæ´»åœ¨æ°´ä¸­ï¼Œä½†ç‰ å€‘æ˜¯ç”¨è‚ºå‘¼å¸çš„å“ºä¹³å‹•ç‰©ã€‚"
        }
        */
    </script>
</body>
</html>